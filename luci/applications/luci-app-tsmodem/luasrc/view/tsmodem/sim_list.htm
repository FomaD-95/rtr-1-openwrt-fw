<% --[[=========== JS ==========]] %>
<%+tsmodem/ui_utils/utils.js%>
<%+tsmodem/ui_utils/external.js%>
<%+tsmodem/ui_override/TextFieldStyled.js%>
<%+tsmodem/sim.js%>
<%+tsmodem/sim_modal%>

<% --[[=========== UI WIDGETS ==========]] %>
<%+tsmodem/ui_widget/UIEventBus.js%>
<%+tsmodem/ui_widget/UITextareaHighlighted.js%>
<%+tsmodem/ui_widget/UIWebSocket.js%>
<%+tsmodem/ui_widget/UISiminfo.js%>
<%+tsmodem/ui_widget/UISimSettingModal.js%>
<%+tsmodem/ui_widget/UICover.js%>
<%+tsmodem/ui_widget/UICountdown.js%>

<% 	--[[=========== STYLES ==========]] %>
<%+tsmodem/css%>

<% 	--[[=========== TSMODEM.CONSOLE ==========]] %>

<%+tsmconsole/ui_widgets/UIModal.js%>

<% --[[=========== LUA BACKEND ==========]] %>

<%
	local config = "tsmodem"
	local uci = require "luci.model.uci".cursor()
	local util = require "luci.util"


	local sims_config = {} 	-- got from UCI config
	local sims_state = {}	-- got from realtime data
	sims_state = {
		["0"] = {
			balance = 29.30,
			balance_date = "15.05.2021",
			rssi = 21,
			bor = 0
		},
		["1"] = {
			balance = 280.55,
			balance_date = "15.05.2021",
			rssi = 28,
			bor = 1
		}

	}


	local ubus_sim = util.ubus("tsmodem.driver", "sim", {})
	local ubus_balance = util.ubus("tsmodem.driver", "balance", {})

	local sim_id = nil
	if(ubus_sim and type(ubus_balance) == "table") then
		sim_id = ubus_sim["value"]
	end



	if (sim_id and ((sim_id == "0") or (sim_id == "1")) and ubus_balance and (type(ubus_balance) == "table")) then
		uci:set("tsmodem", "sim_" .. sim_id, "balance", tostring(ubus_balance["value"]))
		uci:set("tsmodem", "sim_" .. sim_id, "balance_time", tostring(ubus_balance["time"]))
		uci:commit(config)


	end


	uci:foreach(config, "sim", function(a)
		sims_config[#sims_config+1] = a
	end)
	util.perror("=========================")
	util.dumptable(sims_config)
	local i = 1
	local function animationWrapper(str, is_active)
		local html = ''
		str = "" .. str
		if is_active then
			for c=1, #str do
				html = html .. string.format('<span class="anime">%s</span>', str:sub(c,c))
			end
		else html = str end
		return html
	end
%>

<% --[[=========== HTML ==========]] %>
<div id="view">
	<h2 name="content"><%:Mobile device of distant control %></h2>
	<div class="table cbi-map-descr">
		<div class="td">
			<p><%:Communication with the mobile device is supported by the main and reserved channels. %>
			<%:Switching to the reserved channel is performed when the following events occur %>:</p>
				<ul>
					<li><%:Loss of registration in the network %></li>
					<li><%:Weak signal %></li>
					<li><%:Balance below minimum %></li>
				</ul>
			</p>
		</div>
		<div class="td" style="width: 50%; vertical-align: top;">
			<div id="ui-countdown"></div>
		</div>
	</div>
	<h3><%:GSM network channels (SIM cards states) %></h3>

	<div class="table" id="simcards_rows">
		<div class="tr table-titles">
			<div class="th">N</div>
			<div class="th"><%:Name %></div>
			<div class="th" style="width: 33%;"><%:Status %></div>
			<div class="th"><%:PING %></div>
			<div class="th"><%:Mode %></div>
			<div class="th"><%:Strength %></div>
			<div class="th"><%:Balance %></div>
			<div class="th center nowrap cbi-section-actions"><%:Actions %></div>
		</div>
	</div>
</div>


<h3><%:System log %></h3>
<div class="table journal">
	<div class="tr table-titles">
		<div class="th" style="width: 150px;"><%:Date / time %></div>
		<div class="th" style="width: 33%;"><%:Event %></div>
		<div class="th"><%:Source %></div>
		<div class="th"><%:Command %></div>
		<div class="th" style="padding-left: 25px;"><%:Responce %></div>
	</div>
	<div class="tr journal-empty">
		<div class="td"></div>
		<div class="td" style="text-align: right; color: grey;">
			<b><i><%:System log is empty. %></i></b>
		</div>
		<div class="td"></div>
		<div class="td"></div>
		<div class="td" style="background-image: none;"></div>
	</div>
</div>
<div class="clear-journal" style="margin-top: 20px; text-align: center;">
	<input type="button" class="cbi-button cbi-button-apply"
		onclick="clearJournal()"
		value="<%:Clear the log %>"
	/>
</div>

<span id="btn_enable_spinner" class="btn_spinner"></span>

<script type="text/javascript">
//<![CDATA[

L.require("ui").then(function(ui){
	L.require('dom').then(function(dom) {
		var sim_0 = new ui.Siminfo("Name 1", {
			simid: "0",
			name: "Name",
			provider: "Неопределён",
			netreg: "7",
			ping_status: "-",
			netmode: "-",
			signal: "-",
			balance: "-",
		});
		var sim_1 = new ui.Siminfo("Name 2", {
			simid: "1",
			name: "Name",
			provider: "Неопределён",
			netreg: "7",
			ping_status: "-",
			netmode: "-",
			signal: "-",
			balance: "-",
		});

		var viewWrapper= document.getElementById('simcards_rows');
		viewWrapper.appendChild(sim_0.render())
		viewWrapper.appendChild(sim_1.render())



		var sim_0_setting = new ui.SimSettingModal("Настройки сим-карты", {
			simid: "0",
		});

		var ui_cover = new ui.Cover("Переключение сим-карты", {
			simid: "0",
		});
		var widget_ui_cover = ui_cover.render()
		$("body").append(widget_ui_cover)

		var viewWrapper= document.getElementById('simcards_rows');
		var widget_simsetting_0 = sim_0_setting.render()
		viewWrapper.appendChild(widget_simsetting_0)

		var console_modal = new ui.Modal();
		$("body").append(console_modal.render())
	});
});


//]]>
</script>
